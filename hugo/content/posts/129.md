---
title: LaravelでGraphQLを使う
date: 2022-11-13T16:01:31+09:00
publishDate: 2022-11-13T18:06:03+09:00
lastmod: 2022-11-13T18:06:03+09:00
draft: false
tags: [laravel,graphql]
categories: [a]
author: GOD-oda
ogImage: "/images/ogImage/129.png"
---

# 前提
- Laravelの初期化が終わっている
- [Lighthouse](https://lighthouse-php.com/)を使う
- デフォルトのスキーマを利用する

コードは[こちら](https://github.com/GOD-oda/neta/tree/master/issues/129)にまとめてある

# sqlite準備
- `DB_CONNECTION`を`sqlite`にする
- `DB_DATABASE`をコメントアウトする
- 空の`database/database.sqlite`を作成する

```env {fn="src/.env"}
.
.
.
DB_CONNECTION=sqlite
DB_HOST=127.0.0.1
DB_PORT=3306
#DB_DATABASE=laravel
DB_USERNAME=root
DB_PASSWORD=
.
.
.
```

マイグレーションと初期データを入れる（`database/seeders/DatabaseSeeder.php`のコメントアウトを外しておく）
```shell
% docker compose exec app php artisan migrate:migrate --seed
```

# Lighthouseをインストールする

コンテナにてコマンドを実行する
```shell
% composer require nuwave/lighthouse
```

インストールが完了した時点で`graphql`というエンドポイントが増えていることが確認できる

```shell
% php artisan route:list

  GET|HEAD   / ...................................................................................................................... 
  POST       _ignition/execute-solution ............... ignition.executeSolution › Spatie\LaravelIgnition › ExecuteSolutionController
  GET|HEAD   _ignition/health-check ........................... ignition.healthCheck › Spatie\LaravelIgnition › HealthCheckController
  POST       _ignition/update-config ........................ ignition.updateConfig › Spatie\LaravelIgnition › UpdateConfigController
  GET|HEAD   api/user ............................................................................................................... 
  GET|HEAD   api/users .............................................................................................................. 
  GET|POST|HEAD graphql ............................................................. graphql › Nuwave\Lighthouse › GraphQLController
  GET|HEAD   sanctum/csrf-cookie .................................. sanctum.csrf-cookie › Laravel\Sanctum › CsrfCookieController@show
```

スキーマファイルをデフォルトから複製する
```shell
% php artisan vendor:publish --tag=lighthouse-schema
```

```graphql {fn="src/graphql/schema.graphql"}
"A datetime string with format `Y-m-d H:i:s`, e.g. `2018-05-23 13:43:32`."
scalar DateTime @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\DateTime")

"Indicates what fields are available at the top level of a query operation."
type Query {
    "Find a single user by an identifying attribute."
    user(
      "Search by primary key."
      id: ID @eq @rules(apply: ["prohibits:email", "required_without:email"])

      "Search by email address."
      email: String @eq @rules(apply: ["prohibits:id", "required_without:id", "email"])
    ): User @find

    "List multiple users."
    users(
      "Filters by name. Accepts SQL LIKE wildcards `%` and `_`."
      name: String @where(operator: "like")
    ): [User!]! @paginate(defaultCount: 10)
}

"Account of a person who utilizes this application."
type User {
    "Unique primary key."
    id: ID!

    "Non-unique name."
    name: String!

    "Unique email address."
    email: String!

    "When the email was verified."
    email_verified_at: DateTime

    "When the account was created."
    created_at: DateTime!

    "When the account was last updated."
    updated_at: DateTime!
}
```

# データ取得
## 複数のUserを取得

- paginatorが必須としている`count`を指定する
- `currentPage`はなくても動作する
- `data`に欲しいUserの項目を指定する

```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{users{paginatorInfo{count,currentPage}data{id,name,email}}}"}' localhost:8080/graphql
{"data":{"users":{"paginatorInfo":{"count":10,"currentPage":1},"data":[{"id":"1","name":"Mrs. Aglae Hayes PhD","email":"cayla30@example.net"},{"id":"2","name":"Delfina Bartell","email":"audreanne01@example.org"},{"id":"3","name":"Darius Lehner PhD","email":"zheidenreich@example.org"},{"id":"4","name":"Chase Trantow","email":"franecki.roxane@example.net"},{"id":"5","name":"Cielo Morar PhD","email":"lubowitz.jonathon@example.net"},{"id":"6","name":"Florine Kuhic","email":"stephon40@example.com"},{"id":"7","name":"Ms. Eugenia Lueilwitz Jr.","email":"arch.collins@example.org"},{"id":"8","name":"Cindy Welch","email":"bridgette.hintz@example.org"},{"id":"9","name":"Ms. Cordie Waelchi","email":"ncassin@example.com"},{"id":"10","name":"Ms. Rhoda Schaden","email":"zlebsack@example.net"}]}}}
```

1件のみ取得

- 件数の絞りは`first`を使う（内部で定義されている）
```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{users(first:1){paginatorInfo{count,currentPage}data{id,name,email}}}"}' localhost:8080/graphql
{"data":{"users":{"paginatorInfo":{"count":1,"currentPage":1},"data":[{"id":"1","name":"Mrs. Aglae Hayes PhD","email":"cayla30@example.net"}]}}}
```

1件かつ2ページ目
- ページ指定は`page`を使う
```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{users(first:1,page:2){paginatorInfo{count,currentPage}data{id,name,email}}}"}' localhost:8080/graphql
{"data":{"users":{"paginatorInfo":{"count":1,"currentPage":2},"data":[{"id":"2","name":"Delfina Bartell","email":"audreanne01@example.org"}]}}}
```

名前で絞る
- LIKE検索になっているので`"%foo%"`の形にする
```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{users(name:\"%Aglae%\"){paginatorInfo{count,currentPage}data{id,name,email}}}"}' localhost:8080/graphql
{"data":{"users":{"paginatorInfo":{"count":1,"currentPage":1},"data":[{"id":"1","name":"Mrs. Aglae Hayes PhD","email":"cayla30@example.net"}]}}}
```

## 1件取得
ID指定
```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{user(id:1){id,name,email}}"}' localhost:8080/graphql
{"data":{"user":{"id":"1","name":"Mrs. Aglae Hayes PhD","email":"cayla30@example.net"}}
```

email指定
```shell
% curl -XPOST -H 'Content-Type: application/json' -d '{"query":"{user(email:\"cayla30@example.net\"){id,name,email}}"}' localhost:8080/graphql
{"data":{"user":{"id":"1","name":"Mrs. Aglae Hayes PhD","email":"cayla30@example.net"}}}
```

スキーマを見るとID指定は`required_without:email`、email指定は`required_without:id`となっているのでどちらかが必須となる

# TIPS
## 補完
このようなシンタックスエラーが気になる時はヘルパーファイルを作ると良い

{{<figure src="/images/129/1.webp">}}

```shell
% php artisan lighthouse:ide-helper
Wrote schema directive definitions to /var/www/html/schema-directives.graphql.
Wrote definitions for programmatically registered types to /var/www/html/programmatic-types.graphql.
Wrote PHP definitions to /var/www/html/_lighthouse_ide_helper.php.

It is recommended to add them to your .gitignore file.
```

## GUI
[laravel-graphql-playground](https://github.com/mll-lab/laravel-graphql-playground)というのが紹介されているのでインストールする

```shell
% composer require mll-lab/laravel-graphiql
```

`graphiql`というエンドポイントが追加される
```shell
% php artisan route:list

  GET|HEAD   / ........................................................................................................ 
  POST       _ignition/execute-solution . ignition.executeSolution › Spatie\LaravelIgnition › ExecuteSolutionController
  GET|HEAD   _ignition/health-check ............. ignition.healthCheck › Spatie\LaravelIgnition › HealthCheckController
  POST       _ignition/update-config .......... ignition.updateConfig › Spatie\LaravelIgnition › UpdateConfigController
  GET|HEAD   api/user ................................................................................................. 
  GET|HEAD   graphiql .................................................... graphiql › MLL\GraphiQL › GraphiQLController
  GET|POST|HEAD graphql ............................................... graphql › Nuwave\Lighthouse › GraphQLController
  GET|HEAD   sanctum/csrf-cookie .................... sanctum.csrf-cookie › Laravel\Sanctum › CsrfCookieController@show

                                                                                                     Showing [8] routes
```

実際にアクセスしてクエリを書くと結果が返ってくる

{{<figure src="/images/129/2.webp">}}

# 参考
- https://lighthouse-php.com/
- https://graphql.org/
- https://learn.liferay.com/dxp/latest/ja/headless-delivery/consuming-apis/consuming-graphql-apis.html
- https://qiita.com/yousan/items/c898f0d2ceb8f145e5a4
- https://qiita.com/jintz/items/c9105dca1725224d36a8
- https://qiita.com/TsukasaGR/items/1a8b0020e5e83e7a46c7
- https://github.com/mll-lab/laravel-graphql-playground
