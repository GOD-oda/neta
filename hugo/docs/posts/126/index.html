<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="amazon lightsail container serviceに保持できるイメージ数は合計150なのでいつかは上限に達する その時に画面ポチポチで削除するのは手間でめんどいので自動でや" />
  <meta property="og:title" content="amazon lightsail container serviceのイメージを削除するgithub actions" />
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://oda.world/images/ogImage/126.png" />
  <meta property="og:site_name" content="ODA WORLD" />
  <meta property="og:description" content="amazon lightsail container serviceに保持できるイメージ数は合計150なのでいつかは上限に達する その時に画面ポチポチで削除するのは手間でめんどいので自動でや" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@oskfjzp" />
  <meta name="twitter:player" content="@oskfjzp" />
  <title>amazon lightsail container serviceのイメージを削除するgithub actions</title>

  
  <link rel="apple-touch-icon" sizes="57x57" href="https://oda.world/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://oda.world/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://oda.world/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://oda.world/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://oda.world/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://oda.world/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://oda.world/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://oda.world/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://oda.world/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://oda.world/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://oda.world/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://oda.world/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://oda.world/favicon-16x16.png">
  <link rel="manifest" href="https://oda.world/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/tomorrow-night-bright.min.css">

  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  
  <link rel="stylesheet" href="https://oda.world/sass/main.min.50d6e56410147544b69d3b32821363cf7c9f4e3afaee125062f67ee727ce5c9a.css">

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-M5XP83QSK8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-M5XP83QSK8');
  </script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6572411330656614"
          crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1 class="text-center">amazon lightsail container serviceのイメージを削除するgithub actions</h1>
      <div class="icon-content d-flex justify-content-evenly">
        
        
        <a href="https://github.com/GOD-oda"><img src="https://oda.world/images/github.png"></a>
        
        
        <a href="https://www.facebook.com/last.pass.oda"><img src="https://oda.world/images/facebook.png"></a>
        
        
        <a href="https://twitter.com/@oskfjzp"><img src="https://oda.world/images/twitter.png"></a>
        
        
        
        <a href="https://oda.world/index.xml"><img src="https://oda.world/images/feed.png"></a>
      </div>
    </div>
  </header>



<article>
  <div class="container">
    <aside class="mb-1 text-end">
      <div class="publish-date">
        公開日: <time datetime="2022-10-15 14:44:12 &#43;0900 JST">2022/10/15 14:44:12</time>
      </div>
      <div class="updated-date">
        更新日: <time datetime="2022-11-09 00:52:11 &#43;0900 JST">2022/11/09 00:52:11</time>
      </div>
    </aside>

    <div class="section row">
      <div class="col-md-9">
        <div class="content">
          <p>amazon lightsail container serviceに保持できるイメージ数は合計150なのでいつかは上限に達する</p>
<p>その時に画面ポチポチで削除するのは手間でめんどいので自動でやってしまおうという話</p>
<p>実行タイミングは一旦は任意にしたかったのでgithub actionsから実行できるようにしている</p>
<p>先に完成形を載せておく（shellスクリプトをあんまり書かないので雑なのはご愛嬌）</p>
<p>やってることは至って単純でAWS CLIをgithub actionsから実行して削除するだけ</p>
<div class="highlight" fn=".github/workflows/clean_up_images.yml"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">name</span>: <span style="color:#ae81ff">CleanUpImages</span>
<span style="color:#f92672">on</span>:
  <span style="color:#f92672">workflow_dispatch</span>:
<span style="color:#f92672">jobs</span>:
  <span style="color:#f92672">clean</span>:
    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
    <span style="color:#f92672">steps</span>:
      - <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@v3</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Setup AWS cli and lightsail plugin</span>
        <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">          curl &#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34; -o &#34;awscliv2.zip&#34;
</span><span style="color:#e6db74">          unzip awscliv2.zip
</span><span style="color:#e6db74">          sudo ./aws/install --update
</span><span style="color:#e6db74">          curl &#34;https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl&#34; -o &#34;/usr/local/bin/lightsailctl&#34;
</span><span style="color:#e6db74">          sudo chmod +x /usr/local/bin/lightsailctl</span>          
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Configure AWS credentials</span>
        <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">aws-actions/configure-aws-credentials@v1</span>
        <span style="color:#f92672">with</span>:
          <span style="color:#f92672">aws-access-key-id</span>: <span style="color:#ae81ff">${{ secrets.AWS_ACCESS_KEY_ID }}</span>
          <span style="color:#f92672">aws-secret-access-key</span>: <span style="color:#ae81ff">${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
          <span style="color:#f92672">aws-region</span>: <span style="color:#ae81ff">${{ secrets.AWS_REGION }}</span>
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Clean up</span>
        <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">          LIGHTSAIL_CONTAINER_IMAGES=$(aws lightsail get-container-images --service-name ${{ secrets.LIGHTSAIL_SERVICE_NAME }} | jq &#39;.containerImages | reverse&#39;)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">          # Remove all app_images other than latest
</span><span style="color:#e6db74">          APP_IMAGES=$(echo &#34;$LIGHTSAIL_CONTAINER_IMAGES&#34; | jq &#39;.[] | select(contains({image: &#34;app&#34;}))&#39; | jq -s &#39;.&#39;)
</span><span style="color:#e6db74">          APP_IMAGE_LENGTH=$(echo &#34;$APP_IMAGES&#34; | jq &#39;length&#39;)
</span><span style="color:#e6db74">          if [ &#34;$APP_IMAGE_LENGTH&#34; -gt 2 ]; then
</span><span style="color:#e6db74">            for i in `seq 0 $((${APP_IMAGE_LENGTH} - 2))`; do
</span><span style="color:#e6db74">              IMAGE_NAME=$(echo &#34;$APP_IMAGES&#34; | jq -r &#39;.[&#39;&#34;$i&#34;&#39;] | .image&#39;)
</span><span style="color:#e6db74">              aws lightsail delete-container-image --service-name ${{ secrets.LIGHTSAIL_SERVICE_NAME }} --image &#34;$IMAGE_NAME&#34;
</span><span style="color:#e6db74">            done
</span><span style="color:#e6db74">          fi
</span><span style="color:#e6db74">          
</span><span style="color:#e6db74">          # Remove all web_images other than latest
</span><span style="color:#e6db74">          WEB_IMAGES=$(echo &#34;$LIGHTSAIL_CONTAINER_IMAGES&#34; | jq &#39;.[] | select(contains({image: &#34;web&#34;}))&#39; | jq -s &#39;.&#39;)
</span><span style="color:#e6db74">          WEB_IMAGE_LENGTH=$(echo &#34;$WEB_IMAGES&#34; | jq &#39;length&#39;)
</span><span style="color:#e6db74">          if [ &#34;$WEB_IMAGE_LENGTH&#34; -gt 2 ]; then
</span><span style="color:#e6db74">            for i in `seq 0 $((${WEB_IMAGE_LENGTH} - 2))`; do
</span><span style="color:#e6db74">              IMAGE_NAME=$(echo &#34;$WEB_IMAGES&#34; | jq -r &#39;.[&#39;&#34;$i&#34;&#39;] | .image&#39;)
</span><span style="color:#e6db74">              aws lightsail delete-container-image --service-name ${{ secrets.LIGHTSAIL_SERVICE_NAME }} --image &#34;$IMAGE_NAME&#34;
</span><span style="color:#e6db74">            done
</span><span style="color:#e6db74">          fi</span>          
</code></pre></div><p>構成はweb（ウェブサーバ）とapp（アプリケーションサーバ）になっている</p>
<p>また各イメージ名は<code>web:{連番}</code>、<code>app:{連番}</code>として登録している</p>
<h2 id="シークレットを登録する">シークレットを登録する</h1>
<p>今回必要なのは以下</p>
<ul>
<li>AWS_ACCESS_KEY_ID</li>
<li>AWS_SECRET_ACCESS_KEY</li>
<li>AWS_REGION</li>
<li>LIGHTSAIL_SERVICE_NAME</li>
</ul>
<p>LIGHTSAIL_SERVICE_NAMEはこれ</p>
<figure><img src="https://oda.world/images/126/1.webp"/>
</figure>

<p>シークレット登録はリポジトリページのここから</p>
<figure><img src="https://oda.world/images/126/2.webp"/>
</figure>

<h2 id="削除処理">削除処理</h1>
<p>サービスから全てのイメージを取得する</p>
<p>ここで古い順に並べ替えているのは後のループ処理のため</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">LIGHTSAIL_CONTAINER_IMAGES<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws lightsail get-container-images --service-name <span style="color:#e6db74">${</span>{ secrets.LIGHTSAIL_SERVICE_NAME <span style="color:#e6db74">}</span><span style="color:#f92672">}</span> | jq <span style="color:#e6db74">&#39;.containerImages | reverse&#39;</span><span style="color:#66d9ef">)</span>
</code></pre></div><p>全イメージのうちappイメージのみを取得して最新のイメージ<strong>以外</strong>を削除している</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">APP_IMAGES<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$LIGHTSAIL_CONTAINER_IMAGES<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;.[] | select(contains({image: &#34;app&#34;}))&#39;</span> | jq -s <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#66d9ef">)</span>
APP_IMAGE_LENGTH<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$APP_IMAGES<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;length&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$APP_IMAGE_LENGTH<span style="color:#e6db74">&#34;</span> -gt <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  <span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">`</span>seq <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">$((</span><span style="color:#e6db74">${</span>APP_IMAGE_LENGTH<span style="color:#e6db74">}</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">))</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
    IMAGE_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$APP_IMAGES<span style="color:#e6db74">&#34;</span> | jq -r <span style="color:#e6db74">&#39;.[&#39;</span><span style="color:#e6db74">&#34;</span>$i<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;] | .image&#39;</span><span style="color:#66d9ef">)</span>
    aws lightsail delete-container-image --service-name <span style="color:#e6db74">${</span>{ secrets.LIGHTSAIL_SERVICE_NAME <span style="color:#e6db74">}</span><span style="color:#f92672">}</span> --image <span style="color:#e6db74">&#34;</span>$IMAGE_NAME<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>これをweb用にも書く</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">WEB_IMAGES<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$LIGHTSAIL_CONTAINER_IMAGES<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;.[] | select(contains({image: &#34;web&#34;}))&#39;</span> | jq -s <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#66d9ef">)</span>
WEB_IMAGE_LENGTH<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$WEB_IMAGES<span style="color:#e6db74">&#34;</span> | jq <span style="color:#e6db74">&#39;length&#39;</span><span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$WEB_IMAGE_LENGTH<span style="color:#e6db74">&#34;</span> -gt <span style="color:#ae81ff">2</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  <span style="color:#66d9ef">for</span> i in <span style="color:#e6db74">`</span>seq <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">$((</span><span style="color:#e6db74">${</span>WEB_IMAGE_LENGTH<span style="color:#e6db74">}</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">))</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
    IMAGE_NAME<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$WEB_IMAGES<span style="color:#e6db74">&#34;</span> | jq -r <span style="color:#e6db74">&#39;.[&#39;</span><span style="color:#e6db74">&#34;</span>$i<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;] | .image&#39;</span><span style="color:#66d9ef">)</span>
    aws lightsail delete-container-image --service-name <span style="color:#e6db74">${</span>{ secrets.LIGHTSAIL_SERVICE_NAME <span style="color:#e6db74">}</span><span style="color:#f92672">}</span> --image <span style="color:#e6db74">&#34;</span>$IMAGE_NAME<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><h2 id="github-actions実行">github actions実行</h1>
<p>ここから実行する</p>
<figure><img src="https://oda.world/images/126/3.webp"/>
</figure>

<p>実行して成功するとこうなる</p>
<figure><img src="https://oda.world/images/126/4.webp"/>
</figure>

<p>イメージはこうなる</p>
<p>before
<figure><img src="https://oda.world/images/126/5.webp"/>
</figure>
</p>
<p>after
<figure><img src="https://oda.world/images/126/6.webp"/>
</figure>
</p>
<h2 id="参考">参考</h1>
<ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/lightsail/delete-container-image.html">https://docs.aws.amazon.com/cli/latest/reference/lightsail/delete-container-image.html</a></li>
</ul>


          <hr>

          <div class="tags">
  
    
      <a href="https://oda.world/tags/amazon-lightsail/" class="tag"># amazon lightsail</a>
    
      <a href="https://oda.world/tags/amazon-lightsail-container-service/" class="tag"># amazon lightsail container service</a>
    
      <a href="https://oda.world/tags/aws-cli/" class="tag"># aws cli</a>
    
      <a href="https://oda.world/tags/github-actions/" class="tag"># github-actions</a>
    
  
</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="toc sticky-top">
          <div class="toc-title">
            目次
          </div>
          <div class="toc-body">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#シークレットを登録する">シークレットを登録する</a></li>
    <li><a href="#削除処理">削除処理</a></li>
    <li><a href="#github-actions実行">github actions実行</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</article>

  <footer>
    <div class="container">
      <div class="copyright">
        © 2021 ODA WORLD
      </div>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  </body>
</html>

