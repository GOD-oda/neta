<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="前提 ビルドしたイメージはdocker hubにプッシュする php-fpmではLaravelを動かす aws cliは使わない Amazon Lightsailの画面" />
  <meta property="og:title" content="Lightsail container serviceでnginx, php-fpm構成を試す" />
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://blog.oda.world/og_image.png" />
  <meta property="og:site_name" content="ODA WORLD" />
  <meta property="og:description" content="前提 ビルドしたイメージはdocker hubにプッシュする php-fpmではLaravelを動かす aws cliは使わない Amazon Lightsailの画面" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@oskfjzp" />
  <meta name="twitter:player" content="@oskfjzp" />
  <title>Lightsail container serviceでnginx, php-fpm構成を試す</title>
  <link href="https://blog.oda.world/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  
  
  <link href="https://blog.oda.world/css/syntax.css"> 
  
  <link rel="apple-touch-icon" sizes="57x57" href="https://blog.oda.world/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://blog.oda.world/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://blog.oda.world/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog.oda.world/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://blog.oda.world/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://blog.oda.world/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://blog.oda.world/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://blog.oda.world/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.oda.world/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://blog.oda.world/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.oda.world/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://blog.oda.world/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.oda.world/favicon-16x16.png">
  <link rel="manifest" href="https://blog.oda.world/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="https://blog.oda.world/sass/main.min.16de26b8759977d1cfde43c45a53dca1bc25280f1ee52a752366d1bd4f5b64f4.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://blog.oda.world/images/default.png);}
  
  </style>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-93E1496REW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-93E1496REW');
  </script>
  <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
</head>
<body>
  <div class="header-section">
    <ul id="slide-out" class="side-nav">
      <li><a href="https://blog.oda.world"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
      <li><a href="https://blog.oda.world/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
      <li><a href="https://blog.oda.world/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    </ul>
    <a data-activates="slide-out" class="btn-floating button-collapse nav-menu" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">Lightsail container serviceでnginx, php-fpm構成を試す</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
         
         
           <a href="https://github.com/GOD-oda"><img src="https://blog.oda.world/images/github2-dreamstale35.png"></a>
         
         
           <a href="https://www.facebook.com/last.pass.oda"><img src="https://blog.oda.world/images/facebook-dreamstale25.png"></a>
         
         
           <a href="https://twitter.com/@oskfjzp"><img src="https://blog.oda.world/images/twitter-dreamstale71.png"></a>
         
         
         
         <a href="https://blog.oda.world/index.xml"><img src="https://blog.oda.world/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
  </div>



<div class="article">
  <div class="container">
    <div class="section">
  
      <div class="row">
        <div class="col s12">
          <div class="">
            
            <p>
             
            </p>
            <p><h1 id="前提">前提</h1>
<ul>
<li>ビルドしたイメージはdocker hubにプッシュする</li>
<li>php-fpmではLaravelを動かす</li>
<li>aws cliは使わない</li>
<li>Amazon Lightsailの画面でポチポチしていく</li>
<li>ローカルでの作業はmac M1を使う</li>
<li>ゴールはデプロイしてパブリックドメインにアクセス→laravelのトップページが表示されること
<ul>
<li>RDBなどとは連携しない</li>
<li>php.iniとかnginxのdefault.confとかは雑に作る</li>
</ul>
</li>
</ul>
<div class="message ">

Lightsail container serviceがどういうものかは割愛<br>

</div>

<p>完成したコード</p>
<p><a href="https://github.com/GOD-oda/neta/tree/master/issues/85">https://github.com/GOD-oda/neta/tree/master/issues/85</a></p>
<h1 id="ローカルで環境を用意する">ローカルで環境を用意する</h1>
<p>最初に用意するのはDockerfileとdocker-compose.yml</p>
<p>まずはphp-fpmのDockerfileを<code>docker/php</code>に作る</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> php:8.1.3-fpm</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> COMPOSER_ALLOW_SUPERUSER<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>	COMPOSER_HOME<span style="color:#f92672">=</span>/composer<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>composer:2.1 /usr/bin/composer /usr/bin/composer<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    apt-get -y install git zip unzip<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>次はnginxのDockerfileを<code>docker/nginx</code>に作る</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx:1.21-alpine</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> docker/nginx/conf.d/default.conf /etc/nginx/conf.d<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>それとdefault.confを<code>docker/nginx/conf.d</code>に作る</p>
<pre tabindex="0"><code class="language-default.conf" data-lang="default.conf">server {
	listen 80 default_server;

	access_log  /var/log/nginx/access.log  main;
	error_log /var/log/nginx/error.log warn;

	root /var/www/html/public;

	location / {
		try_files $uri $uri/ /index.php?$query_string;
	}

	error_page 500 502 503 504 /50x.html;

	location ~ \.php$ {
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass app:9000;
		fastcgi_index index.php;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

		fastcgi_max_temp_file_size 0;
		fastcgi_buffer_size 4K;
		fastcgi_buffers 64 4k;

		include fastcgi_params;
	}
}
</code></pre><p>で、最後にdocker-compose.ymlを作る</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker-compose.yml" data-lang="docker-compose.yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.9&#34;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">app</span>:
    <span style="color:#f92672">build</span>:
      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">.</span>
      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">./docker/php/Dockerfile</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">type</span>: <span style="color:#ae81ff">bind</span>
         <span style="color:#f92672">source</span>: <span style="color:#ae81ff">./src</span>
         <span style="color:#f92672">target</span>: <span style="color:#ae81ff">/var/www/html</span>
  <span style="color:#f92672">nginx</span>:
    <span style="color:#f92672">build</span>:
      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">.</span>
      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">./docker/nginx/Dockerfile</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;8000:80&#34;</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">app</span>
</code></pre></div><p>そしたらイメージをビルドしてからLaravelを用意する</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir -p src
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker compose build --no-cache --force-rm
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker compose run --rm app composer create-project --prefer-dist laravel/laravel .
</code></pre></div><p>ここまでローカル用の環境は整ったね</p>
<pre tabindex="0"><code>.
├── docker
│   ├── nginx
│   │   ├── Dockerfile
│   │   └── conf.d
│   └── php
│       └── Dockerfile
├── docker-compose.yml
└── src
</code></pre><p>コンテナ起動して<code>localhost:8000</code>にアクセスするとlaravelのトップページが表示されるはず</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157707337-4a78366b-b0aa-4dd3-af13-be9716dedde4.png" alt="スクリーンショット 2022-03-11 1 19 15"></p>
<h1 id="イメージをビルドしてdocker-hubにプッシュする">イメージをビルドしてdocker hubにプッシュする</h1>
<h2 id="nginxのイメージ">nginxのイメージ</h2>
<p>ここすんごいハマった箇所だけど、まずは結論から</p>
<ol>
<li><code>linux/amd64</code>アーキテクチャとしてビルドする</li>
<li>デプロイするnginxのfastcgi_passは<code>localhost:9000</code>とする</li>
</ol>
<p>1つ目はCPUアーキテクチャの問題</p>
<p>M1チップのmacでビルドしたイメージのCPUアーキテクチャは<code>arm64</code>になるけどLightsail container serviceで動くCPUアーキテクチャは<code>linux/amd64</code>らしい（理由はわからんし詳しく調べてない</p>
<p>ということなのでビルドする時に<code>--platform linux/amd64,linux/arm64</code>をつける必要がある（<code>linux/arm64</code>って必要ないように思えるけどつけないと動かなかった。理由はわからんしry</p>
<p>だけど<code>--platform</code>オプションを使うには<code>docker buildx</code>コマンドになるので<a href="https://docs.docker.com/buildx/working-with-buildx/">Docker Buildx</a>をインストールしておこう</p>
<p>2つ目はLightsail container serviceの問題（？）</p>
<p>どうも<code>localhost:9000</code>と書かないと動かないがローカルでは<code>localhost:9000</code>とは書きたくない</p>
<p>ということなのでマルチステージビルドを利用してローカル用と本番用のdefault.confを切り分けよう</p>
<p><code>docker/nginx/conf.d/default.conf</code>を<code>default-local.conf</code>と<code>default-prod.conf</code>の2つにして、<code>default-prod.conf</code>のfastcgi_passを修正する</p>
<pre tabindex="0"><code>docker/nginx/conf.d
├── default-local.conf
└── default-prod.conf
</code></pre><p>違いはここだけ</p>
<pre tabindex="0"><code>diff docker/nginx/conf.d/default-local.conf docker/nginx/conf.d/default-prod.conf
17c17
&lt; 		fastcgi_pass app:9000;
---
&gt; 		fastcgi_pass localhost:9000;
</code></pre><p>では次にDockerfileを下記のように修正する</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">FROM nginx:1.21-alpine AS base

FROM base AS dev

COPY ./docker/nginx/conf.d/default-local.conf /etc/nginx/conf.d/default.conf

FROM base AS prod

COPY ./docker/nginx/conf.d/default-prod.conf /etc/nginx/conf.d/default.conf
</code></pre></div><p>またdocker-compose.ymlも下記のように修正する</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">version: &#34;3.9&#34;
services:
  app:
    build:
      context: .
      dockerfile: ./docker/php/Dockerfile
    volumes:
      - type: bind
        source: ./src
        target: /var/www/html
  nginx:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
<span style="color:#a6e22e">+     target: ${APP_BUILD_TARGET:-local}
</span><span style="color:#a6e22e"></span>    ports:
      - &#34;8000:80&#34;
    depends_on:
      - app
</code></pre></div><h2 id="php-fpmのイメージ">php-fpmのイメージ</h2>
<p>php-fpmのイメージもローカル用と本番用にする</p>
<p>と言っても今回はローカル用イメージですることはなく、必要に応じてphp.iniとかをコピーすればいいと思う</p>
<p>本番用はcomposer installとパーミッションくらい</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#a6e22e">+ FROM php:8.1.3-fpm AS base
</span><span style="color:#a6e22e"></span>
  WORKDIR /var/www/html

  ENV COMPOSER_ALLOW_SUPERUSER=1 \
      COMPOSER_HOME=/composer

  COPY --from=composer:2.1 /usr/bin/composer /usr/bin/composer

  RUN apt-get update &amp;&amp; \
      apt-get -y install git zip unzip

<span style="color:#a6e22e">+ FROM base AS local
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+ FROM base AS prod
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+ COPY ./src .
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+ RUN composer install --no-dev &amp;&amp; \
</span><span style="color:#a6e22e">+     chmod -R 777 storage bootstrap/cache
</span></code></pre></div><p>docker-compose.ymlはtargetの指定をする</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">.
.
.
services:
  app:
    build:
      context: .
      dockerfile: ./docker/php/Dockerfile
<span style="color:#a6e22e">+     target: ${APP_BUILD_TARGET:-local}
</span><span style="color:#a6e22e"></span>.
.
.
</code></pre></div><h2 id="docker-hubにプッシュする">docker hubにプッシュする</h2>
<p>docker hubにログインした状態で次のコマンドを実行する</p>
<pre tabindex="0"><code>docker buildx build --no-cache --force-rm --platform linux/amd64,linux/arm64 -t gododa/lightsail-container-sample-nginx:latest --target prod -f ./docker/nginx/Dockerfile --push .
docker buildx build --no-cache --force-rm --platform linux/amd64,linux/arm64 -t gododa/lightsail-container-sample-app:latest --target prod -f ./docker/php/Dockerfile --push .
</code></pre><ul>
<li>&ndash;platformでアーキテクチャの指定をする</li>
<li>-tでタグをつける
<ul>
<li>本番に使うイメージは常に最新でいいとおもうからlastestとかでいいんじゃないかな</li>
</ul>
</li>
<li>&ndash;targetでDockerfileのprodを指定する</li>
<li>-fでDockerfileを指定する</li>
<li>&ndash;pushでプッシュを行う（これがないとただのビルド）</li>
</ul>
<p>成功するとdocker hubで確認できる</p>
<p>それぞれのアーキテクチャにamd64が含まれていればOK</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157815514-27a09e99-095e-47a9-b74e-56077a9bfae2.png" alt="スクリーンショット 2022-03-11 14 59 52"></p>
<p><img src="https://user-images.githubusercontent.com/14949022/157815557-4564eca8-ec5f-4789-ae17-c94183fc8430.png" alt="スクリーンショット 2022-03-11 15 00 01"></p>
<h1 id="lightsail-container-serviceにデプロイ">Lightsail container serviceにデプロイ</h1>
<p>ここからは画面ポチポチ作業ゲー</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157816762-bf97cc94-1fe4-4666-bcc4-959e399beac1.png" alt="スクリーンショット_2022-03-11_15_04_46"></p>
<p><img src="https://user-images.githubusercontent.com/14949022/157816776-6434c021-a55d-40ff-9a70-ada24dc7099c.png" alt="スクリーンショット_2022-03-11_15_04_56"></p>
<p>regionは東京、capacityはNa、scaleは1</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157817026-a3532518-ca99-4465-888c-2c5ae25d7e68.png" alt="スクリーンショット 2022-03-11 15 05 30"></p>
<p>deploymentはSpecify a custom deploymentを選択してdocker hubのイメージを指定する</p>
<p>また、nginxコンテナにパブリックエンドポイントを設定する</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157817109-3f03c605-efea-4fa4-81af-0708bd05b57d.png" alt="FireShot Capture 009 - Create a container service - Lightsail - lightsail aws amazon com"></p>
<p>コンテナサービス名は<code>sample</code>とする</p>
<p>最後にCreate container serviceボタンを押して作成中になる</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157817479-b7585f29-1d82-4ce1-8966-d5a59f6c362d.png" alt="スクリーンショット 2022-03-11 15 22 21"></p>
<p>完了したらpublic domainのリンクをクリックしてトップページが表示されればOK</p>
<p>お疲れっした</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157817533-c00b6bea-4c56-426d-8690-c23e45767ebd.png" alt="スクリーンショット 2022-03-11 15 32 47"></p>
<p>完成コード再掲</p>
<p><a href="https://github.com/GOD-oda/neta/tree/master/issues/85">https://github.com/GOD-oda/neta/tree/master/issues/85</a></p>
<h1 id="感想">感想</h1>
<ul>
<li>ちょっとハマるポイントがあるけど僕みたいにネットワーク周り詳しくないけどコンテナ使いたいぞ！って人は良いサービスかなと思う</li>
<li>定額なのでランニングコストは抑えられそうな気もする（データベースやロードバランサー等々も定額みたいね</li>
<li>コンテナスペックを最大にしたら$3200 USD / monthで、アプリケーション規模とコストとの相談次第だけどスケーリングについてはある程度頑張れそう</li>
<li>デプロイはやっぱ遅いっぽい</li>
<li>datadogなどのagentを入れられるとかなんとか</li>
</ul>
<h1 id="ハマった点をもう少し">ハマった点をもう少し</h1>
<h2 id="cpuアーキテクチャ">CPUアーキテクチャ</h2>
<p>今回使った<code>nginx:1.21-alpine</code>も<code>php:8.1.3-fpm</code>もarm64だと死ぬんだよな</p>
<p><code>--platform</code>をつけずにdocker hubにプッシュするとしっかりと<code>linux/arm64/v8</code>になってる</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157819285-93ff5431-6062-4421-b1b3-69be06d0e67c.png" alt="スクリーンショット 2022-03-11 16 08 21"></p>
<p><img src="https://user-images.githubusercontent.com/14949022/157819301-363428a3-f961-4d4c-8d53-49c141206378.png" alt="スクリーンショット 2022-03-11 16 08 32"></p>
<p>これを利用してデプロイすると失敗するんだけど、そのログがこれ</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157471960-85f61d9c-4d01-4117-8456-a477cbb7b048.png" alt="スクリーンショット_2022-03-10_0_19_39"></p>
<p><a href="https://dev.classmethod.jp/articles/how-to-fix-standard-init-linux-error/">こちらの記事</a>のエラーパターンその3が該当したっぽくて、amd64にしたら動いたと</p>
<p>深ぼってないから本当にそうかはわからんけど動いたからいいやw</p>
<h2 id="nginxのfastcgi_passの設定">nginxのfastcgi_passの設定</h2>
<p>これがお作法なのかはわからんがなーんでlocalhostになるの</p>
<p>ローカルで環境を整えた場合にnginxからphp-fpmに流す時に通常はfastcgi_passはphp-fpmの<code>コンテナ名:ポート</code>で指定する</p>
<p>php-fpmのportはデフォルトで9000で、php-fpmのコンテナ名はappとしよう</p>
<p>とするとdefault.confはこう書く</p>
<pre tabindex="0"><code class="language-default.conf" data-lang="default.conf">server {
.
.
.
  location ~ \.php$ {
    fastcgi_pass app:9000;
  }
}
</code></pre><p>これでデプロイすると何故か死ぬ</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157824347-5db39c02-9aea-4c56-9173-5fb6ccd13edd.png" alt="スクリーンショット_2022-03-11_16_33_31"></p>
<p>nginx→php-fpmってtcpじゃね？だからtcpで9000を解放したらいけんじゃね？とかいう安直な考えでやってみた</p>
<p>が！！！</p>
<p>ダメ！！！</p>
<p><img src="https://user-images.githubusercontent.com/14949022/157826110-94eabfb8-4745-43ad-b519-999689a79b60.png" alt="スクリーンショット 2022-03-11 16 54 43"></p>
<p><img src="https://user-images.githubusercontent.com/14949022/157826398-a2796fea-e6d6-4fa9-bba7-8e7911405cda.png" alt="スクリーンショット_2022-03-11_16_58_20"></p>
<p><a href="https://lightsail.aws.amazon.com/ls/docs/en_us/articles/amazon-lightsail-container-services">この図</a>を見ると1つのNode内に複数のContainer1, 2, 3がある（Nodeが2つなのはscaleが2になっているから</p>
<p>nginxとphp-fpmのContainerができるはずなんだけど、このコンテナ間の通信は<code>localhost</code>を指定することで何故か可能になる</p>
<p>うーむ、よくわからん</p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://dev.classmethod.jp/articles/announcing-amazon-lightsail-containers/">https://dev.classmethod.jp/articles/announcing-amazon-lightsail-containers/</a></li>
<li><a href="https://note.varu3.me/n/nb9d691f9b307">https://note.varu3.me/n/nb9d691f9b307</a></li>
<li><a href="https://dev.classmethod.jp/articles/how-to-fix-standard-init-linux-error/">https://dev.classmethod.jp/articles/how-to-fix-standard-init-linux-error/</a></li>
<li><a href="https://medium.com/geekculture/deploying-php-app-as-a-container-services-in-amazon-lightsail-with-github-actions-edbe68fcb45d">https://medium.com/geekculture/deploying-php-app-as-a-container-services-in-amazon-lightsail-with-github-actions-edbe68fcb45d</a></li>
<li><a href="https://repost.aws/questions/QUoYzGuzJBSE-0iWuBeliLaw/communication-between-lightsail-containers">https://repost.aws/questions/QUoYzGuzJBSE-0iWuBeliLaw/communication-between-lightsail-containers</a></li>
<li><a href="https://docs.docker.com/buildx/working-with-buildx/">https://docs.docker.com/buildx/working-with-buildx/</a></li>
<li><a href="https://gendosu.jp/archives/3512">https://gendosu.jp/archives/3512</a></li>
</ul>
</p>
            <p>
              
                
                  <a href="https://blog.oda.world/tags/nginx/">#nginx</a>
                
                  <a href="https://blog.oda.world/tags/macm1/">#macM1</a>
                
                  <a href="https://blog.oda.world/tags/php/">#php</a>
                
                  <a href="https://blog.oda.world/tags/php-fpm/">#php-fpm</a>
                
                  <a href="https://blog.oda.world/tags/amazon-lightsail/">#amazon lightsail</a>
                
                  <a href="https://blog.oda.world/tags/laravel/">#laravel</a>
                
                  <a href="https://blog.oda.world/tags/amazon-lightsail-container-sevice/">#amazon lightsail container sevice</a>
                
              
            </p>
            <hr>
            <p>
              更新日 2022/03/11 17:34:36
            </p>
            
          </div>
        </div>
      </div>
  
      <div class="row">
        <div class="col s3 m1">
        
          <a class="btn-floating btn-large waves-effect waves-light" href="https://blog.oda.world/posts/84/">prev</a>
        
        </div>
        <div class="col s6 m10 center">&nbsp</div>
        <div class="col s3 m1">
        
          <a class="btn-floating btn-large disabled">next</a>
        
        </div>
      </div>
  
    </div>
  </div>
</div>

  <footer class="container">
    <div class="copyright">
      © 2021 ODA WORLD
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://blog.oda.world/js/materialize.min.js"></script>
  <script src="https://blog.oda.world/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

