<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="ゴール earthlyコマンドを使えるようにする goでチュートリアルを進める Earthlyとは チュートリアルにはこう書かれていた Earthly is a build automation to" />
  <meta property="og:title" content="macでEarthlyを使ってみる" />
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://blog.oda.world/og_image.png" />
  <meta property="og:site_name" content="ODA WORLD" />
  <meta property="og:description" content="ゴール earthlyコマンドを使えるようにする goでチュートリアルを進める Earthlyとは チュートリアルにはこう書かれていた Earthly is a build automation to" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@oskfjzp" />
  <meta name="twitter:player" content="@oskfjzp" />
  <title>macでEarthlyを使ってみる</title>
  <link href="https://blog.oda.world/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  
  
  <link href="https://blog.oda.world/css/syntax.css"> 
  
  <link rel="apple-touch-icon" sizes="57x57" href="https://blog.oda.world/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://blog.oda.world/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://blog.oda.world/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog.oda.world/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://blog.oda.world/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://blog.oda.world/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://blog.oda.world/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://blog.oda.world/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.oda.world/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://blog.oda.world/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.oda.world/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://blog.oda.world/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.oda.world/favicon-16x16.png">
  <link rel="manifest" href="https://blog.oda.world/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="https://blog.oda.world/sass/main.min.68affff2399fd8690426dc3e3c5c01239977e82a5ab4b9a9cf2325f41f70537b.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://blog.oda.world/images/default.png);}
  
  </style>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-93E1496REW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-93E1496REW');
  </script>
  <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
</head>
<body>
  <div class="header-section">
    <ul id="slide-out" class="side-nav">
      <li><a href="https://blog.oda.world"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
      <li><a href="https://blog.oda.world/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
      <li><a href="https://blog.oda.world/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    </ul>
    <a data-activates="slide-out" class="btn-floating button-collapse nav-menu" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">macでEarthlyを使ってみる</h1>
        <div class="row center">
          <h5 class="header col s12 light"></h5>
        </div>
        <div class="row center">
         
         
           <a href="https://github.com/GOD-oda"><img src="https://blog.oda.world/images/github2-dreamstale35.png"></a>
         
         
           <a href="https://www.facebook.com/last.pass.oda"><img src="https://blog.oda.world/images/facebook-dreamstale25.png"></a>
         
         
           <a href="https://twitter.com/@oskfjzp"><img src="https://blog.oda.world/images/twitter-dreamstale71.png"></a>
         
         
         
         <a href="https://blog.oda.world/index.xml"><img src="https://blog.oda.world/images/feed-dreamstale27.png"></a>
        </div>
      </div>
    </div>
  </div>



<div class="article">
  <div class="container">
    <div class="section">
  
      <div class="row">
        <div class="col s12">
          <div class="">
            
            <p>
             
            </p>
            <p><h1 id="ゴール">ゴール</h1>
<ul>
<li>earthlyコマンドを使えるようにする</li>
<li>goでチュートリアルを進める</li>
</ul>
<h1 id="earthlyとは">Earthlyとは</h1>
<p><a href="https://docs.earthly.dev/basics">チュートリアル</a>にはこう書かれていた</p>
<blockquote>
<p>Earthly is a build automation tool that uses docker containers to enforce build repeatability. Earthly is meant to be run on your local system and in your CI. Earthly&rsquo;s implicit caching and parallelism will make your builds repeatable and fast.</p>
</blockquote>
<p>Dockerを使ってなんやかんやするビルド自動化ツールであると</p>
<p>そしてこれに尽きると思う</p>
<p><strong>Makefile + Dockerfile = Earthfile</strong></p>
<p>DockerfileにMakeコマンドが書けるんですな</p>
<h1 id="準備">準備</h1>
<p>earthlyコマンドを使えるようにするために<a href="https://earthly.dev/get-earthly">brew</a>を使ってインストールする</p>
<p>前提条件にDocker for macとGitがあるが省略（だいたいの人が入ってると思うから）</p>
<p>インストール自体はコマンド一発（同時に初期化もしてるみたい）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% brew install earthly/earthly/earthly <span style="color:#f92672">&amp;&amp;</span> earthly bootstrap
Updating Homebrew...
<span style="color:#f92672">==</span>&gt; Downloading https://ghcr.io/v2/homebrew/portable-ruby/portable-ruby/blobs/sha256:f2d5cab5a4dd49e5b3de780a3cd0a1f61642fea247d1c25aa40cd43f1be290b5
<span style="color:#75715e">################################################################################################################################################## 100.0%</span>
<span style="color:#f92672">==</span>&gt; Pouring portable-ruby-2.6.8.arm64_big_sur.bottle.tar.gz
.
.
.
<span style="color:#f92672">==</span>&gt; Caveats
zsh completions have been installed to:
  /opt/homebrew/share/zsh/site-functions
<span style="color:#f92672">==</span>&gt; Summary
🍺  /opt/homebrew/Cellar/earthly/0.5.24: <span style="color:#ae81ff">8</span> files, 31.2MB, built in <span style="color:#ae81ff">1</span> minute <span style="color:#ae81ff">25</span> seconds
zsh: command not found: .earthly
</code></pre></div><p>コピペで実行すると<code>zsh: command not found: .earthly</code>で死んだので再度実行する（<code>earthly bootstrap</code>の部分だな）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% earthly bootstrap
           buildkitd | Starting buildkit daemon as a docker container <span style="color:#f92672">(</span>earthly-buildkitd<span style="color:#f92672">)</span>...
Error: bootstrap new buildkitd client: maybe start buildkitd: start: could not start buildkit: <span style="color:#ae81ff">1</span> error occurred:
	* command failed: docker run --privileged --env BUILDKIT_TLS_ENABLED<span style="color:#f92672">=</span>false --env BUILDKIT_DEBUG<span style="color:#f92672">=</span>false --env BUILDKIT_TCP_TRANSPORT_ENABLED<span style="color:#f92672">=</span>false --label dev.earthly.settingshash<span style="color:#f92672">=</span>7fdf5da38c9e48ae --mount type<span style="color:#f92672">=</span>volume,source<span style="color:#f92672">=</span>earthly-cache,dst<span style="color:#f92672">=</span>/tmp/earthly --publish 127.0.0.1:8373:8373/tcp -d --name earthly-buildkitd earthly/buildkitd:v0.5.24: exit status 125: docker: Error: remote trust data does not exist <span style="color:#66d9ef">for</span> docker.io/earthly/buildkitd: notary.docker.io does not have trust data <span style="color:#66d9ef">for</span> docker.io/earthly/buildkitd.
See <span style="color:#e6db74">&#39;docker run --help&#39;</span>.: exit status <span style="color:#ae81ff">125</span>
</code></pre></div><p>またしても死んだのでエラーをよく見てみると以下の文を発見</p>
<pre><code>docker: Error: remote trust data does not exist for docker.io/earthly/buildkitd: notary.docker.io does not have trust data for docker.io/earthly/buildkitd.
</code></pre><p>そういえば信頼できないイメージはpull出来ないようにしてたな（信頼できないイメージ扱いなのかw</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% printenv | grep DOCKER                                                                                                                        
DOCKER_CONTENT_TRUST<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>ということで一時的に環境変数を書き換える</p>
<pre><code>% export DOCKER_CONTENT_TRUST=0
% printenv | grep DOCKER
DOCKER_CONTENT_TRUST=0
</code></pre><p>さぁもう一度！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% earthly bootstrap
           buildkitd | Starting buildkit daemon as a docker container <span style="color:#f92672">(</span>earthly-buildkitd<span style="color:#f92672">)</span>...
           buildkitd | ...Done
           bootstrap | Bootstrapping successful.
</code></pre></div><p>これでとりあえず準備はできた</p>
<h1 id="ファイルの準備">ファイルの準備</h1>
<p><a href="https://docs.earthly.dev/basics/part-1-a-simple-earthfile">https://docs.earthly.dev/basics/part-1-a-simple-earthfile</a> を進めていく</p>
<p>まずここではearthfileとgoスクリプトを書くが適当にディレクトリを作り、そこで作業していくこととする</p>
<h2 id="earthfile">earthfile</h2>
<pre><code>FROM golang:1.15-alpine3.13
WORKDIR /go-example

build:
    COPY main.go .
    RUN go build -o build/go-example main.go
    SAVE ARTIFACT build/go-example /go-example AS LOCAL build/go-example

docker:
    COPY +build/go-example .
    ENTRYPOINT [&quot;/go-example/go-example&quot;]
    SAVE IMAGE go-example:latest
</code></pre><p>ターゲット名に+をつけて実行するとのこと</p>
<p>なのでbuildを実行する場合はこのようになる</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% earthly +build
</code></pre></div><p>ターゲットについての補足は<a href="https://docs.earthly.dev/basics/part-1b-detailed-explanation#note">こちら</a>を見ると良い</p>
<p>ここでは4パターン挙げられている</p>
<ul>
<li>ローカルのターゲットでearthfileと同じディレクトリ</li>
<li>ローカルのターゲットでearthfileと別のディレクトリ</li>
<li>リモートのターゲット</li>
<li>アーティファクト</li>
</ul>
<h2 id="maingo">main.go</h2>
<pre><code>package main

import &quot;fmt&quot;

func main() {
    fmt.Println(&quot;hello world&quot;)
}
</code></pre><h1 id="ビルドからの実行">ビルドからの実行</h1>
<p><a href="https://docs.earthly.dev/basics/part-2-running-the-build">https://docs.earthly.dev/basics/part-2-running-the-build</a> を進めていく</p>
<p>ビルドしようと思ったけどチュートリアルでは<code>docker</code>ターゲットなので素直に従う（どっちにしろbuildを実行してるのでOK）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% earthly +docker
           buildkitd | Found buildkit daemon as docker container <span style="color:#f92672">(</span>earthly-buildkitd<span style="color:#f92672">)</span>
golang:1.15-alpine3.13 | --&gt; Load metadata linux/arm64
             context | --&gt; local context .
               +base | --&gt; FROM golang:1.15-alpine3.13
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> resolve docker.io/library/golang:1.15-alpine3.13@sha256:330f31a4415d97bb64f244d5f4d838bea7a7ee1ab5a1a0bac49e7973c57cbb88 ... 100%
             context | transferred <span style="color:#ae81ff">2</span> file<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> <span style="color:#66d9ef">for</span> context . <span style="color:#f92672">(</span><span style="color:#ae81ff">429</span> B, <span style="color:#ae81ff">2</span> file/dir stats<span style="color:#f92672">)</span>
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> sha256:d7d764ad64d0038ea03fb6ee5dfa27eae252ca86cb3ab7467a50799f49d4b0b1 ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> sha256:d148012ef14d1adc0862e9b1b8fd6d1ebc801566179b1286f28e09bc036ce5d0 ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> sha256:24495759ef4524087397498411c1d5f78a8b27844b429b41ac1916eeb009203b ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> extracting sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> extracting sha256:24495759ef4524087397498411c1d5f78a8b27844b429b41ac1916eeb009203b ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> extracting sha256:d148012ef14d1adc0862e9b1b8fd6d1ebc801566179b1286f28e09bc036ce5d0 ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> sha256:eebab785e1f02a7ccbcd73e08e6bddda070ca9222bc1279e8cde4fc0ce1908eb ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> extracting sha256:eebab785e1f02a7ccbcd73e08e6bddda070ca9222bc1279e8cde4fc0ce1908eb ... 100%
               +base | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> extracting sha256:d7d764ad64d0038ea03fb6ee5dfa27eae252ca86cb3ab7467a50799f49d4b0b1 ... 100%
               +base | --&gt; WORKDIR /go-example
              +build | --&gt; COPY main.go .
              +build | --&gt; RUN go build -o build/go-example main.go
              +build | --&gt; SAVE ARTIFACT build/go-example +build/go-example AS LOCAL build/go-example
             +docker | --&gt; COPY +build/go-example ./
              output | --&gt; exporting outputs
              output | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> exporting layers ... 100%
              output | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> exporting manifest sha256:410dc0da1e2de45f62dfe0eb392dd58bcf6abb65223b352faf33ec70a29371d6 ... 100%
              output | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> exporting config sha256:03af2f2f54c52e9fd3abafa8f0b19884f64f744d2339c898ad7cb9f262d3d500 ... 100%
              output | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> copying files ... 100%
              output | <span style="color:#f92672">[</span>██████████<span style="color:#f92672">]</span> transferring <span style="color:#f92672">(</span>via tar<span style="color:#f92672">)</span> docker.io/library/go-example:latest ... 100%
<span style="color:#f92672">================================</span> SUCCESS <span style="color:#f92672">[</span>main<span style="color:#f92672">]</span> <span style="color:#f92672">================================</span>
             +docker | Image +docker as go-example:latest
              +build | Artifact +build/go-example as local build/go-example
</code></pre></div><p>これでビルドされたgoスクリプトが<code>build/go-example</code>に配置される</p>
<p>また<code>go-example</code>というイメージが作られていることも確認できる</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% docker images
REPOSITORY          TAG       IMAGE ID       CREATED          SIZE
go-example          latest    3c04213bdc07   <span style="color:#ae81ff">28</span> seconds ago   297MB
</code></pre></div><p>んでイメージを実行してみよう</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">% docker run --rm go-example:latest
hello world
</code></pre></div><p>ようこそ、世界</p>
<h1 id="感想">感想</h1>
<p>単純にビルドとか早い（いい感じに並列処理してる）みたいだけど、最低限の動作のとこだけだし正直これだけだとメリットわからん</p>
<p>チュートリアルはまだ続きがあって依存ライブラリ関連のことやキャッシュのことなどなどもうちょいやってみるかなぁ</p>
<p>今までのDockerfileとMakefileでも十分な気もするがやはりCIと絡めた方がより恩恵にあずかれそう</p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://docs.earthly.dev/">https://docs.earthly.dev/</a></li>
<li><a href="https://earthly.dev/get-earthly">https://earthly.dev/get-earthly</a></li>
<li><a href="https://github.com/earthly/earthly">https://github.com/earthly/earthly</a></li>
</ul>
</p>
            <p>
              
                
                  <a href="https://blog.oda.world/tags/docker/">#docker</a>
                
                  <a href="https://blog.oda.world/tags/go/">#go</a>
                
                  <a href="https://blog.oda.world/tags/git/">#git</a>
                
                  <a href="https://blog.oda.world/tags/earthly/">#earthly</a>
                
                  <a href="https://blog.oda.world/tags/makefile/">#makefile</a>
                
              
            </p>
            <hr>
            <p>
              更新日 2021/11/16 17:04:07
            </p>
            
          </div>
        </div>
      </div>
  
      <div class="row">
        <div class="col s3 m1">
        
          <a class="btn-floating btn-large waves-effect waves-light" href="https://blog.oda.world/posts/76/">prev</a>
        
        </div>
        <div class="col s6 m10 center">&nbsp</div>
        <div class="col s3 m1">
        
          <a class="btn-floating btn-large disabled">next</a>
        
        </div>
      </div>
  
    </div>
  </div>
</div>

  <footer class="container">
    <div class="copyright">
      © 2021 ODA WORLD
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://blog.oda.world/js/materialize.min.js"></script>
  <script src="https://blog.oda.world/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

