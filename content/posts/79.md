---
title: macã§Earthlyã‚’ä½¿ã£ã¦ã¿ã‚‹
date: 2021-11-16T15:08:35
publishDate: 2021-11-16T17:04:07+09:00
draft: false
tags: [docker,go,git,earthly,makefile]
---

# ã‚´ãƒ¼ãƒ«
- earthlyã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
- goã§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€²ã‚ã‚‹

# Earthlyã¨ã¯

[ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://docs.earthly.dev/basics)ã«ã¯ã“ã†æ›¸ã‹ã‚Œã¦ã„ãŸ

> Earthly is a build automation tool that uses docker containers to enforce build repeatability. Earthly is meant to be run on your local system and in your CI. Earthly's implicit caching and parallelism will make your builds repeatable and fast.

Dockerã‚’ä½¿ã£ã¦ãªã‚“ã‚„ã‹ã‚“ã‚„ã™ã‚‹ãƒ“ãƒ«ãƒ‰è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ã¨

ãã—ã¦ã“ã‚Œã«å°½ãã‚‹ã¨æ€ã†

**Makefile + Dockerfile = Earthfile**

Dockerfileã«Makeã‚³ãƒãƒ³ãƒ‰ãŒæ›¸ã‘ã‚‹ã‚“ã§ã™ãª

# æº–å‚™
earthlyã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«[brew](https://earthly.dev/get-earthly)ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

å‰ææ¡ä»¶ã«Docker for macã¨GitãŒã‚ã‚‹ãŒçœç•¥ï¼ˆã ã„ãŸã„ã®äººãŒå…¥ã£ã¦ã‚‹ã¨æ€ã†ã‹ã‚‰ï¼‰

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è‡ªä½“ã¯ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºï¼ˆåŒæ™‚ã«åˆæœŸåŒ–ã‚‚ã—ã¦ã‚‹ã¿ãŸã„ï¼‰
```sh
% brew install earthly/earthly/earthly && earthly bootstrap
Updating Homebrew...
==> Downloading https://ghcr.io/v2/homebrew/portable-ruby/portable-ruby/blobs/sha256:f2d5cab5a4dd49e5b3de780a3cd0a1f61642fea247d1c25aa40cd43f1be290b5
################################################################################################################################################## 100.0%
==> Pouring portable-ruby-2.6.8.arm64_big_sur.bottle.tar.gz
.
.
.
==> Caveats
zsh completions have been installed to:
  /opt/homebrew/share/zsh/site-functions
==> Summary
ğŸº  /opt/homebrew/Cellar/earthly/0.5.24: 8 files, 31.2MB, built in 1 minute 25 seconds
zsh: command not found: .earthly
```

ã‚³ãƒ”ãƒšã§å®Ÿè¡Œã™ã‚‹ã¨`zsh: command not found: .earthly`ã§æ­»ã‚“ã ã®ã§å†åº¦å®Ÿè¡Œã™ã‚‹ï¼ˆ`earthly bootstrap`ã®éƒ¨åˆ†ã ãªï¼‰

```sh
% earthly bootstrap
           buildkitd | Starting buildkit daemon as a docker container (earthly-buildkitd)...
Error: bootstrap new buildkitd client: maybe start buildkitd: start: could not start buildkit: 1 error occurred:
	* command failed: docker run --privileged --env BUILDKIT_TLS_ENABLED=false --env BUILDKIT_DEBUG=false --env BUILDKIT_TCP_TRANSPORT_ENABLED=false --label dev.earthly.settingshash=7fdf5da38c9e48ae --mount type=volume,source=earthly-cache,dst=/tmp/earthly --publish 127.0.0.1:8373:8373/tcp -d --name earthly-buildkitd earthly/buildkitd:v0.5.24: exit status 125: docker: Error: remote trust data does not exist for docker.io/earthly/buildkitd: notary.docker.io does not have trust data for docker.io/earthly/buildkitd.
See 'docker run --help'.: exit status 125
```

ã¾ãŸã—ã¦ã‚‚æ­»ã‚“ã ã®ã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚ˆãè¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®æ–‡ã‚’ç™ºè¦‹

```
docker: Error: remote trust data does not exist for docker.io/earthly/buildkitd: notary.docker.io does not have trust data for docker.io/earthly/buildkitd.
```

ãã†ã„ãˆã°ä¿¡é ¼ã§ããªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯pullå‡ºæ¥ãªã„ã‚ˆã†ã«ã—ã¦ãŸãªï¼ˆä¿¡é ¼ã§ããªã„ã‚¤ãƒ¡ãƒ¼ã‚¸æ‰±ã„ãªã®ã‹w

```sh
% printenv | grep DOCKER                                                                                                                        
DOCKER_CONTENT_TRUST=1
```

ã¨ã„ã†ã“ã¨ã§ä¸€æ™‚çš„ã«ç’°å¢ƒå¤‰æ•°ã‚’æ›¸ãæ›ãˆã‚‹

```
% export DOCKER_CONTENT_TRUST=0
% printenv | grep DOCKER
DOCKER_CONTENT_TRUST=0
```

ã•ãã‚‚ã†ä¸€åº¦ï¼

```sh
% earthly bootstrap
           buildkitd | Starting buildkit daemon as a docker container (earthly-buildkitd)...
           buildkitd | ...Done
           bootstrap | Bootstrapping successful.
```

ã“ã‚Œã§ã¨ã‚Šã‚ãˆãšæº–å‚™ã¯ã§ããŸ


# ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
https://docs.earthly.dev/basics/part-1-a-simple-earthfile ã‚’é€²ã‚ã¦ã„ã

ã¾ãšã“ã“ã§ã¯earthfileã¨goã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ããŒé©å½“ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã€ãã“ã§ä½œæ¥­ã—ã¦ã„ãã“ã¨ã¨ã™ã‚‹

## earthfile

```
FROM golang:1.15-alpine3.13
WORKDIR /go-example

build:
    COPY main.go .
    RUN go build -o build/go-example main.go
    SAVE ARTIFACT build/go-example /go-example AS LOCAL build/go-example

docker:
    COPY +build/go-example .
    ENTRYPOINT ["/go-example/go-example"]
    SAVE IMAGE go-example:latest
```

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåã«+ã‚’ã¤ã‘ã¦å®Ÿè¡Œã™ã‚‹ã¨ã®ã“ã¨

ãªã®ã§buildã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã“ã®ã‚ˆã†ã«ãªã‚‹
```sh
% earthly +build
```

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã¤ã„ã¦ã®è£œè¶³ã¯[ã“ã¡ã‚‰](https://docs.earthly.dev/basics/part-1b-detailed-explanation#note)ã‚’è¦‹ã‚‹ã¨è‰¯ã„

ã“ã“ã§ã¯4ãƒ‘ã‚¿ãƒ¼ãƒ³æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹

- ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§earthfileã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§earthfileã¨åˆ¥ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- ãƒªãƒ¢ãƒ¼ãƒˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ

## main.go

```
package main

import "fmt"

func main() {
    fmt.Println("hello world")
}
```

# ãƒ“ãƒ«ãƒ‰ã‹ã‚‰ã®å®Ÿè¡Œ
https://docs.earthly.dev/basics/part-2-running-the-build ã‚’é€²ã‚ã¦ã„ã

ãƒ“ãƒ«ãƒ‰ã—ã‚ˆã†ã¨æ€ã£ãŸã‘ã©ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯`docker`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãªã®ã§ç´ ç›´ã«å¾“ã†ï¼ˆã©ã£ã¡ã«ã—ã‚buildã‚’å®Ÿè¡Œã—ã¦ã‚‹ã®ã§OKï¼‰

```sh
% earthly +docker
           buildkitd | Found buildkit daemon as docker container (earthly-buildkitd)
golang:1.15-alpine3.13 | --> Load metadata linux/arm64
             context | --> local context .
               +base | --> FROM golang:1.15-alpine3.13
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] resolve docker.io/library/golang:1.15-alpine3.13@sha256:330f31a4415d97bb64f244d5f4d838bea7a7ee1ab5a1a0bac49e7973c57cbb88 ... 100%
             context | transferred 2 file(s) for context . (429 B, 2 file/dir stats)
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] sha256:d7d764ad64d0038ea03fb6ee5dfa27eae252ca86cb3ab7467a50799f49d4b0b1 ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] sha256:d148012ef14d1adc0862e9b1b8fd6d1ebc801566179b1286f28e09bc036ce5d0 ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] sha256:24495759ef4524087397498411c1d5f78a8b27844b429b41ac1916eeb009203b ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] extracting sha256:595b0fe564bb9444ebfe78288079a01ee6d7f666544028d5e96ba610f909ee43 ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] extracting sha256:24495759ef4524087397498411c1d5f78a8b27844b429b41ac1916eeb009203b ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] extracting sha256:d148012ef14d1adc0862e9b1b8fd6d1ebc801566179b1286f28e09bc036ce5d0 ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] sha256:eebab785e1f02a7ccbcd73e08e6bddda070ca9222bc1279e8cde4fc0ce1908eb ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] extracting sha256:eebab785e1f02a7ccbcd73e08e6bddda070ca9222bc1279e8cde4fc0ce1908eb ... 100%
               +base | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] extracting sha256:d7d764ad64d0038ea03fb6ee5dfa27eae252ca86cb3ab7467a50799f49d4b0b1 ... 100%
               +base | --> WORKDIR /go-example
              +build | --> COPY main.go .
              +build | --> RUN go build -o build/go-example main.go
              +build | --> SAVE ARTIFACT build/go-example +build/go-example AS LOCAL build/go-example
             +docker | --> COPY +build/go-example ./
              output | --> exporting outputs
              output | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] exporting layers ... 100%
              output | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] exporting manifest sha256:410dc0da1e2de45f62dfe0eb392dd58bcf6abb65223b352faf33ec70a29371d6 ... 100%
              output | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] exporting config sha256:03af2f2f54c52e9fd3abafa8f0b19884f64f744d2339c898ad7cb9f262d3d500 ... 100%
              output | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] copying files ... 100%
              output | [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] transferring (via tar) docker.io/library/go-example:latest ... 100%
================================ SUCCESS [main] ================================
             +docker | Image +docker as go-example:latest
              +build | Artifact +build/go-example as local build/go-example
```

ã“ã‚Œã§ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸgoã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ`build/go-example`ã«é…ç½®ã•ã‚Œã‚‹

ã¾ãŸ`go-example`ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ç¢ºèªã§ãã‚‹

```sh
% docker images
REPOSITORY          TAG       IMAGE ID       CREATED          SIZE
go-example          latest    3c04213bdc07   28 seconds ago   297MB
```

ã‚“ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†

```sh
% docker run --rm go-example:latest
hello world
```

ã‚ˆã†ã“ãã€ä¸–ç•Œ

# æ„Ÿæƒ³
å˜ç´”ã«ãƒ“ãƒ«ãƒ‰ã¨ã‹æ—©ã„ï¼ˆã„ã„æ„Ÿã˜ã«ä¸¦åˆ—å‡¦ç†ã—ã¦ã‚‹ï¼‰ã¿ãŸã„ã ã‘ã©ã€æœ€ä½é™ã®å‹•ä½œã®ã¨ã“ã ã‘ã ã—æ­£ç›´ã“ã‚Œã ã‘ã ã¨ãƒ¡ãƒªãƒƒãƒˆã‚ã‹ã‚‰ã‚“

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯ã¾ã ç¶šããŒã‚ã£ã¦ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢é€£ã®ã“ã¨ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã“ã¨ãªã©ãªã©ã‚‚ã†ã¡ã‚‡ã„ã‚„ã£ã¦ã¿ã‚‹ã‹ãªã

ä»Šã¾ã§ã®Dockerfileã¨Makefileã§ã‚‚ååˆ†ãªæ°—ã‚‚ã™ã‚‹ãŒã‚„ã¯ã‚ŠCIã¨çµ¡ã‚ãŸæ–¹ãŒã‚ˆã‚Šæ©æµã«ã‚ãšã‹ã‚Œãã†

# å‚è€ƒ
- https://docs.earthly.dev/
- https://earthly.dev/get-earthly
- https://github.com/earthly/earthly
